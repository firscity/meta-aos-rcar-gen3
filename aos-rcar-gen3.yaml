desc: "Aos development setup for Renesas RCAR Gen3 hardware"
min_ver: "0.20"

variables:
  # Build dirs

  YOCTOS_WORK_DIR: "yocto"
  DOMD_BUILD_DIR: "build-domd"
  DOM0_BUILD_DIR: "zephyr/build-dom0"

  # XT config

  XT_DOMD_DTB_NAME: "%{SOC_FAMILY}-%{MACHINE}-domd.dtb"
  XT_XEN_DTB_NAME: "%{SOC_FAMILY}-%{MACHINE}-xen.dtb"
  XT_PVR_NUM_OSID: "2"
  XT_OP_TEE_FLAVOUR: "generic_dt"

  XT_MULTIMEDIA_EVA_DIR: ""
  XT_PREBUILT_GSX_DIR: ""
  XT_USE_DDK1_11: "0"

  # Aos config

  AOS_UNIT_MODEL: "rcar-demo2023-zephyr"
  AOS_UNIT_VERSION: "1.0"

  AOS_DOM0_NODE_ID: "gen3-dom0"
  AOS_DOM0_NODE_TYPE: "%{AOS_UNIT_MODEL}-%{AOS_UNIT_VERSION}-%{AOS_DOM0_NODE_ID}"

  AOS_DOMD_NODE_ID: "gen3-domd"
  AOS_DOMD_NODE_TYPE: "%{AOS_UNIT_MODEL}-%{AOS_UNIT_VERSION}-%{AOS_DOMD_NODE_ID}"

common_data:
  # Sources used by all yocto-based domains
  sources: &COMMON_SOURCES
    - type: git
      url: "https://git.yoctoproject.org/poky"
      rev: "kirkstone"
    - type: git
      url: "https://git.openembedded.org/meta-openembedded"
      rev: "kirkstone"
    - type: git
      url: "https://git.yoctoproject.org/meta-virtualization"
      rev: "kirkstone"
    - type: git
      url: "https://github.com/xen-troops/meta-xt-common.git"
      rev: "master"
    - type: git
      url: "https://github.com/xen-troops/meta-xt-rcar.git"
      rev: "master"
    - type: git
      url: "https://github.com/aoscloud/meta-aos.git"
      rev: "develop"

  # Common configuration options for all yocto-based domains
  conf: &COMMON_CONF
    - [SSTATE_DIR, "${TOPDIR}/../../../common_data/sstate"]
    - [DL_DIR, "${TOPDIR}/../../../common_data/downloads"]

    - [MACHINE, "%{MACHINE}"]
    - [SOC_FAMILY, "%{SOC_FAMILY}"]

    # Add systemd configuration
    - [INIT_MANAGER, "systemd"]

    # Use hypervisor console on all guests
    - [SERIAL_CONSOLES, "115200;hvc0"]

    # Configure number of supported GPU virtual guests
    - [XT_PVR_NUM_OSID, "%{XT_PVR_NUM_OSID}"]

    # Skip warning about missing "virtualization" distro feature
    - [SKIP_META_VIRT_SANITY_CHECK, "1"]

    # Add for gstreamer plugins ugly
    - [LICENSE_FLAGS_ACCEPTED, "commercial"]

    # Initramfs configuration
    - [INITRAMFS_IMAGE, "aos-image-initramfs"]
    - [INITRAMFS_IMAGE_BUNDLE, "0"]
    - [INITRAMFS_FSTYPES, "cpio.gz"]

    # HACK: force ipk instead of rpm b/c it makes troubles to PVR UM build otherwise
    - [PACKAGE_CLASSES, "package_ipk"]

    # BBMASK

    - [XT_USE_DDK1_11, "%{XT_USE_DDK1_11}"]

    # The bbappends below are only used for old DDK v1.11
    - [
        BBMASK:append,
        " ${@bb.utils.contains('XT_USE_DDK1_11', '1', '', 'meta-xt-rcar-fixups/recipes-kernel/kernel-module-gles/kernel-module-gles.bbappend', d)}",
      ]
    - [
        BBMASK:append,
        " ${@bb.utils.contains('XT_USE_DDK1_11', '1', '', 'meta-xt-rcar-fixups/recipes-graphics/gles-module/gles-user-module.bbappend', d)}",
      ]
    - [
        BBMASK:append,
        " ${@bb.utils.contains('XT_USE_DDK1_11', '1', '', 'meta-xt-rcar-fixups/recipes-graphics/packagegroups/packagegroup-graphic-renesas.bbappend', d)}",
      ]

    - [BBMASK:append, " mesa-gl"]

    # Preferred providers

    - [PREFERRED_PROVIDER_virtual/libgles1, ""]
    - [PREFERRED_PROVIDER_virtual/libgles2, "gles-user-module"]
    - [PREFERRED_PROVIDER_virtual/libgles3, "gles-user-module"]
    - [PREFERRED_PROVIDER_virtual/egl, "libegl"]
    - [PREFERRED_PROVIDER_virtual/libgl, ""]
    - [PREFERRED_PROVIDER_virtual/mesa, ""]
    - [PREFERRED_PROVIDER_virtual/libgbm, "libgbm"]
    - [PREFERRED_PROVIDER_libgbm-dev, "libgbm"]

    # Distro features

    # Remove features that we are not using
    - [
        DISTRO_FEATURES:remove,
        "x11 gtk gobject-introspection-data wifi nfc bluetooth irda zeroconf 3g sysvinit",
      ]

    # Remove ptest to reduce the build time,
    # remove x11 and vulkan to avoid error after removing mesa
    - [DISTRO_FEATURES:remove, " ptest x11 vulkan"]

    # displbe and sndbe
    - [DISTRO_FEATURES:append, " displbe sndbe"]

    # for Wayland/Weston
    - [DISTRO_FEATURES_NATIVESDK:append, " wayland"]
    - [DISTRO_FEATURES:append, " pam"]

    # Machine features

    # Enable Gfx Pkgs
    - [MACHINE_FEATURES:append, " gsx"]
    - [
        BB_MULTI_PROVIDER_ALLOWED:append,
        " virtual/libgl virtual/egl virtual/libgles1 virtual/libgles2",
      ]

    # Configuration for USB 3.0
    - [MACHINE_FEATURES:append, " usb3"]

    # Add Capacity Aware migration Strategy (CAS)
    - [MACHINE_FEATURES:append, " cas"]

    # SDK features

    # add the static lib to SDK toolchain
    - [SDKIMAGE_FEATURES:append, " staticdev-pkgs"]

    # Image install

    # Additional testing and debug tools
    - [IMAGE_INSTALL:append, " expect ltrace evtest"]

    # Install some apps to test GPU/Display
    - [IMAGE_INSTALL:append, " glmark2 kmscube"]

  # The same set of layers and configs is used both in DomD and DomU
  # to build a DDK from source code
  ddk_source_overrides: &DDK_SOURCE_OVERRIDES
    sources:
      - type: git
        url: "https://git.openembedded.org/meta-python2"
        rev: "kirkstone"
      - type: git
        url: "https://github.com/kraj/meta-clang.git"
        rev: "kirkstone"
      - type: git
        url: "ssh://git@gitpct.epam.com/epmd-aepr/img-proprietary"
        rev: "6ed789681c2867c7cae8b0150e093e1e2781797e"
        dir: "proprietary"

    builder:
      conf:
        # gles-um-compile.bb still requires python2
        - [I_SWEAR_TO_MIGRATE_TO_PYTHON3, "yes"]

      layers:
        - "../meta-python2"
        - "../meta-clang"
        - "../meta-xt-rcar/meta-xt-rcar-proprietary"

components:
  dom0:
    build-dir: "%{DOM0_BUILD_DIR}"
    sources:
      - type: west
        url: "https://github.com/aoscloud/aos_core_zephyr.git"
        rev: "develop"

    builder:
      type: zephyr
      board: "%{ZEPHYR_MACHINE}"
      target: aos_core_zephyr
      work_dir: build
      vars:
        - "CONFIG_AOS_NODE_ID=\\\\\\\"%{AOS_DOM0_NODE_ID}\\\\\\\""
        - "CONFIG_AOS_NODE_TYPE=\\\\\\\"%{AOS_DOM0_NODE_TYPE}\\\\\\\""

      shields:
        - "xen_dom0"

      additional_deps:
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/Image-%{MACHINE}.bin"

      target_images:
        - "build/zephyr/zephyr.bin"

  domd:
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES
      - type: git
        url: https://github.com/renesas-rcar/meta-renesas.git
        rev: "kirkstone-dev"
      - type: git
        url: https://git.yoctoproject.org/meta-selinux
        rev: "kirkstone"
      - type: git
        url: "https://github.com/xen-troops/meta-aos-rcar-gen3.git"
        rev: "develop"

    builder:
      type: yocto
      work_dir: "%{DOMD_BUILD_DIR}"
      conf:
        - *COMMON_CONF
        - [XT_DOM_NAME, "domd"]
        - [XT_OP_TEE_FLAVOUR, "%{XT_OP_TEE_FLAVOUR}"]
        - [XT_DEVICE_TREES, "%{XT_DOMD_DTB_NAME} %{XT_XEN_DTB_NAME}"]

        # Machine feature 'multimedia' is used to enable (VSP in domd) and (LOSSY build option in ATF)
        - [MACHINE_FEATURES:append, " multimedia"]
        - [
            PREFERRED_RPROVIDER_libgstallocators-1.0,
            "gstreamer1.0-plugins-base",
          ]
        - [PREFERRED_RPROVIDER_libgstapp-1.0, "gstreamer1.0-plugins-base"]
        - [XT_MULTIMEDIA_EVA_DIR, "%{XT_MULTIMEDIA_EVA_DIR}"]

        # Build our own Xen version rather than proposed by meta-virtualization
        - [PREFERRED_VERSION_xen, "4.17.0+git%"]
        - [PREFERRED_VERSION_xen-tools, "4.17.0+git%"]

      build_target: core-image-weston
      layers:
        - "../poky/meta"
        - "../poky/meta-poky"
        - "../poky/meta-yocto-bsp"
        - "../meta-renesas/meta-rcar-gen3"
        - "../meta-virtualization"
        - "../meta-selinux"
        - "../meta-openembedded/meta-oe"
        - "../meta-openembedded/meta-networking"
        - "../meta-openembedded/meta-python"
        - "../meta-openembedded/meta-filesystems"
        - "../meta-openembedded/meta-gnome"
        - "../meta-xt-common/meta-xt-domx"
        - "../meta-xt-common/meta-xt-driver-domain"
        - "../meta-xt-rcar/meta-oe-fixups"
        - "../meta-xt-rcar/meta-xt-rcar-fixups"
        - "../meta-xt-rcar/meta-xt-rcar-driver-domain"
        - "../meta-xt-rcar/meta-xt-rcar-domx"
        - "../meta-xt-rcar/meta-xt-rcar-gles_common"
        - "../meta-aos"
        - "../meta-aos-rcar-gen3/meta-aos-rcar-gen3-domx"
        - "../meta-aos-rcar-gen3/meta-aos-rcar-gen3-driver-domain"
        - "../meta-aos-rcar-gen3/meta-aos-rcar-gen3-domd"

      target_images:
        - "tmp/deploy/images/%{MACHINE}/Image-%{MACHINE}.bin"
        - "tmp/deploy/images/%{MACHINE}/xen-%{MACHINE}.uImage"
        - "tmp/deploy/images/%{MACHINE}/xenpolicy-%{MACHINE}"
        - "tmp/deploy/images/%{MACHINE}/%{XT_XEN_DTB_NAME}"
        - "tmp/deploy/images/%{MACHINE}/aos-image-initramfs-%{MACHINE}.cpio.gz"
        - "tmp/deploy/images/%{MACHINE}/core-image-weston-%{MACHINE}.ext4"
        - "tmp/work-shared/core-image-weston-%{MACHINE}/rootfs/var"

images:
  full:
    type: gpt
    desc: "Full SD-card/eMMC image"
    partitions:
      boot_a:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: ext4
        size: 128 MiB
        items:
          "xen": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/xen-%{MACHINE}.uImage"
          "xenpolicy": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/xenpolicy-%{MACHINE}"
          "xen.dtb": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/%{XT_XEN_DTB_NAME}"
          "zephyr.bin": "%{DOM0_BUILD_DIR}/build/zephyr/zephyr.bin"
          "linux-domd": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/Image-%{MACHINE}.bin"
          "initramfs-domd": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/aos-image-initramfs-%{MACHINE}.cpio.gz"

      boot_b:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: ext4
        size: 128 MiB
        items:
          "xen": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/xen-%{MACHINE}.uImage"
          "xenpolicy": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/xenpolicy-%{MACHINE}"
          "xen.dtb": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/%{XT_XEN_DTB_NAME}"
          "zephyr.bin": "%{DOM0_BUILD_DIR}/build/zephyr/zephyr.bin"
          "linux-domd": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/Image-%{MACHINE}.bin"
          "initramfs-domd": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/aos-image-initramfs-%{MACHINE}.cpio.gz"

      boot_env:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: vfat
        size: 16 MiB

      domd_rootfs:
        gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
        type: raw_image
        image_path: "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/core-image-weston-%{MACHINE}.ext4"

      domd_var:
        gpt_type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4 # Linux filesystem data
        type: ext4
        size: 1024 MiB
        items:
          "/": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/work-shared/core-image-weston-%{MACHINE}/rootfs/var"

      domd_aos:
        gpt_type: CA7D7CCB-63ED-4C53-861C-1742536059CC # LUKS partition
        type: empty
        size: 1024 MiB

parameters:
  # Machines
  MACHINE:
    desc: "RCAR Gen3-based device"
    salvator-xs-m3-2x4g:
      # This is not misprint. This machine has 2x4 memory config
      overrides:
        variables:
          MACHINE: "salvator-x"
          ZEPHYR_MACHINE: "rcar_salvator_xs_m3"
          SOC_FAMILY: "r8a7796"
          XT_DOMD_CONFIG_NAME: "domd-salvator-xs-m3-2x4g.cfg"
          XT_DOMU_CONFIG_NAME: "domu-generic-m3-2x4g.cfg"
          XT_DOMA_CONFIG_NAME: "doma-generic-m3-2x4g.cfg"
          XT_OP_TEE_FLAVOUR: "salvator_m3_2x4g"
          XT_DOMD_DTB_NAME: "r8a77961-salvator-xs-2x4g-domd.dtb"
          XT_XEN_DTB_NAME: "r8a77961-salvator-xs-2x4g-xen.dtb"

    salvator-xs-h3-4x2g:
      overrides:
        variables:
          MACHINE: "salvator-x"
          ZEPHYR_MACHINE: "rcar_salvator_xs_h3_4x2g"
          SOC_FAMILY: "r8a7795"
          XT_DOMD_CONFIG_NAME: "domd-salvator-xs-h3-4x2g.cfg"
          XT_DOMU_CONFIG_NAME: "domu-generic-h3-4x2g.cfg"
          XT_DOMA_CONFIG_NAME: "doma-generic-h3-4x2g.cfg"
          XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          XT_DOMD_DTB_NAME: "r8a7795-salvator-xs-4x2g-domd.dtb"
          XT_XEN_DTB_NAME: "r8a7795-salvator-xs-4x2g-xen.dtb"

    salvator-x-h3-4x2g:
      overrides:
        variables:
          MACHINE: "salvator-x"
          ZEPHYR_MACHINE: "rcar_salvator_x_h3_4x2g"
          SOC_FAMILY: "r8a7795"
          XT_DOMD_CONFIG_NAME: "domd-salvator-x-h3-4x2g.cfg"
          XT_DOMU_CONFIG_NAME: "domu-generic-h3-4x2g.cfg"
          XT_DOMA_CONFIG_NAME: "doma-generic-h3-4x2g.cfg"
          XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          XT_DOMD_DTB_NAME: "r8a7795-salvator-x-4x2g-domd.dtb"
          XT_XEN_DTB_NAME: "r8a7795-salvator-x-4x2g-xen.dtb"

    h3ulcb-4x2g:
      default: true
      overrides:
        variables:
          MACHINE: "h3ulcb"
          ZEPHYR_MACHINE: "rcar_h3ulcb_ca57"
          SOC_FAMILY: "r8a7795"
          XT_DOMD_CONFIG_NAME: "domd-h3ulcb-4x2g.cfg"
          XT_DOMU_CONFIG_NAME: "domu-generic-h3-4x2g.cfg"
          XT_DOMA_CONFIG_NAME: "doma-generic-h3-4x2g.cfg"
          XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          XT_DOMD_DTB_NAME: "r8a77951-h3ulcb-4x2g-domd.dtb"
          XT_XEN_DTB_NAME: "r8a77951-h3ulcb-4x2g-xen.dtb"

    h3ulcb-4x2g-kf:
      overrides:
        variables:
          MACHINE: "h3ulcb"
          ZEPHYR_MACHINE: "rcar_h3ulcb_ca57"
          SOC_FAMILY: "r8a7795"
          XT_DOMD_CONFIG_NAME: "domd-h3ulcb-4x2g-kf.cfg"
          XT_DOMU_CONFIG_NAME: "domu-generic-h3-4x2g.cfg"
          XT_DOMA_CONFIG_NAME: "doma-generic-h3-4x2g.cfg"
          XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          XT_DOMD_DTB_NAME: "r8a77951-h3ulcb-4x2g-kf-domd.dtb"
          XT_XEN_DTB_NAME: "r8a77951-h3ulcb-4x2g-kf-xen.dtb"

        components:
          domd:
            sources:
              - type: git
                url: "https://github.com/xen-troops/meta-rcar.git"
                rev: "xt-master"

            builder:
              layers:
                - "../meta-rcar/meta-rcar-gen3-adas"
                - "../meta-xt-rcar/meta-xt-cogent-fixups"

              conf:
                # Ignore OP-TEE patches as we have own OP-TEE
                - [BBMASK:append, " meta-rcar-gen3-adas/recipes-bsp/optee"]

    h3ulcb-4x2g-ab:
      overrides:
        variables:
          MACHINE: "h3ulcb"
          ZEPHYR_MACHINE: "rcar_h3ulcb_ca57"
          SOC_FAMILY: "r8a7795"
          XT_DOMD_CONFIG_NAME: "domd-h3ulcb-4x2g-ab.cfg"
          XT_DOMU_CONFIG_NAME: "domu-generic-h3-4x2g.cfg"
          XT_DOMA_CONFIG_NAME: "doma-generic-h3-4x2g.cfg"
          XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          XT_DOMD_DTB_NAME: "r8a77951-h3ulcb-4x2g-ab-domd.dtb"
          XT_XEN_DTB_NAME: "r8a77951-h3ulcb-4x2g-ab-xen.dtb"

  ENABLE_MM:
    desc: "Enable Multimedia support"
    "no":
      default: true
      overrides:
        components:
          domd:
            builder:
              conf:
                # Mask MMP recipes
                - [BBMASK:append, " kernel-module-uvcs-drv omx-user-module"]

    "yes":
      overrides:
        variables:
          # Note 1
          # Folder with multimedia evaluation package, i.e. files:
          #   R-Car_Gen3_Series_Evaluation_Software_Package_for_Linux-*.zip
          #   R-Car_Gen3_Series_Evaluation_Software_Package_of_Linux_Drivers-*.zip
          # Pay attention that you do not need to unpack these files,
          # as they will be unpacked by recipe eval-pack.bb into two
          # subfolders inside specified folder.
          #
          # Note 2
          # You can specify folder in following ways:
          # - absolute path;
          # - relative to domains build root:
          #   - use yocto's internal variable ${TOPDIR};
          #   - or moulin's variable like %{DOMD_BUILD_DIR}.
          #     Pay attention to usage of % instead of $.
          XT_MULTIMEDIA_EVA_DIR: "${TOPDIR}/../../../eva_mm"

        components:
          domd:
            builder:
              conf:
                # If you enable MM you need to specify features that you need.
                # See meta-renesas/meta-rcar-gen3/include/omx-control.inc for
                # list of possible distro features, and make sure that required
                # library is provided to you within Evaluation package.
                # Following line is just example applicable for
                # multimedia evaluation package 20210428.
                - [
                    DISTRO_FEATURES:append,
                    " aaclcdec_lib aaclcdec_mdw aaclcenc_lib aaclcenc_mdw h264dec_lib h264enc_lib",
                  ]
                - ["HOSTTOOLS:append", " unzip "]

  PREBUILT_DDK:
    desc: "Use pre-built GPU drivers"
    "no":
      default: true
      overrides:
        components:
          domd: *DDK_SOURCE_OVERRIDES

    "yes":
      # Folder with prebuilt graphics package, i.e. file ${SOC_NAME}_linux_gsx_binaries_gles.tar.gz
      # is provided as XT_PREBUILT_GSX_DIR variable to components
      overrides:
        variables:
          XT_PREBUILT_GSX_DIR: "${TOPDIR}/../../../prebuilt_gsx"

        components:
          domd:
            builder:
              conf:
                - [XT_PREBUILT_GSX_DIR, "%{XT_PREBUILT_GSX_DIR}"]

  # Aos VIS data provider
  VIS_DATA_PROVIDER:
    desc: "Specifies plugin for VIS automotive data"
    renesassimulator:
      default: true
      overrides:
        variables:
          VIS_DATA_PROVIDER: "renesassimulatoradapter"

    telemetryemulator:
      overrides:
        variables:
          VIS_DATA_PROVIDER: "telemetryemulatoradapter"
